#!/usr/bin/env php
<?php

/**
 * StoneScriptPHP CLI Script Manager
 *
 * Central dispatcher for all CLI scripts in the Framework/cli directory.
 *
 * Usage:
 *   php generate <command> [arguments...]
 *
 * Available commands:
 *   route      Generate a new route handler class
 *   env        Generate or update .env file from schema
 *   model      Generate model classes from PostgreSQL function files
 *   migrate    Database migration management (verify, status, up, down, etc.)
 *   dba        Database administration utilities
 *
 * Examples:
 *   php generate route user-login
 *   php generate env --force
 *   php generate model filename.pssql
 *   php generate migrate verify
 *   php generate dba query "SELECT * FROM users"
 */

// Determine the root path and CLI scripts directory
define('CLI_ROOT_PATH', __DIR__ . DIRECTORY_SEPARATOR);
define('CLI_SCRIPTS_PATH', CLI_ROOT_PATH . 'Framework' . DIRECTORY_SEPARATOR . 'cli' . DIRECTORY_SEPARATOR);

// Available commands mapped to their script files
$available_commands = [
    'route'   => 'generate-route.php',
    'client'  => 'generate-client.php',
    'env'     => 'generate-env.php',
    'model'   => 'generate-model.php',
    'migrate' => 'migrate.php',
    'dba'     => 'dba.php',
];

// Parse command line arguments
$command = $argv[1] ?? null;

// Show help if no command provided or help requested
if ($command === null || $command === 'help' || $command === '--help' || $command === '-h') {
    showHelp($available_commands);
    exit(0);
}

// Check if command exists
if (!isset($available_commands[$command])) {
    echo "Error: Unknown command '$command'\n\n";
    echo "Available commands: " . implode(', ', array_keys($available_commands)) . "\n";
    echo "Run 'php generate help' for more information.\n";
    exit(1);
}

// Get the script file path
$script_file = CLI_SCRIPTS_PATH . $available_commands[$command];

// Verify script file exists
if (!file_exists($script_file)) {
    echo "Error: Script file not found: $script_file\n";
    exit(1);
}

// Prepare arguments for the target script
// Remove the script name (generate) and command name from argv
$script_args = array_slice($argv, 2);

// Build the command to execute
// We need to pass arguments to the target script
$php_binary = PHP_BINARY;
$cmd_parts = [$php_binary, $script_file];

// Add all remaining arguments, properly escaped
foreach ($script_args as $arg) {
    // Escape arguments that contain spaces or special characters
    if (preg_match('/[\s\'"\\\\]/', $arg)) {
        $cmd_parts[] = escapeshellarg($arg);
    } else {
        $cmd_parts[] = $arg;
    }
}

$cmd = implode(' ', $cmd_parts);

// Change to the script directory before executing
// This ensures relative paths in the scripts work correctly
$original_dir = getcwd();
chdir(CLI_SCRIPTS_PATH);

// Execute the script and pass through the output
passthru($cmd, $exit_code);

// Restore original directory
chdir($original_dir);

// Exit with the same code as the script
exit($exit_code);

/**
 * Display help information
 *
 * @param array $commands Available commands
 */
function showHelp(array $commands): void
{
    echo "StoneScriptPHP CLI Script Manager\n";
    echo "==================================\n\n";
    echo "Usage:\n";
    echo "  php generate <command> [arguments...]\n\n";
    echo "Available Commands:\n\n";

    $command_help = [
        'route'   => "Generate a new route handler class\n" .
                     "         Usage: php generate route <method> <path>\n" .
                     "         Example: php generate route post /login",

        'client'  => "Generate TypeScript API client from routes\n" .
                     "         Usage: php generate client [--output=<path>]\n" .
                     "         Example: php generate client --output=frontend/src/api.ts",

        'env'     => "Generate or update .env file from schema\n" .
                     "         Usage: php generate env [--force] [--example]\n" .
                     "         Example: php generate env --force",

        'model'   => "Generate model classes from PostgreSQL function files\n" .
                     "         Usage: php generate model <filename.pssql>\n" .
                     "         Example: php generate model get_user.pssql",

        'migrate' => "Database migration management\n" .
                     "         Usage: php generate migrate <command>\n" .
                     "         Commands: verify, status, up, down, generate\n" .
                     "         Example: php generate migrate verify",

        'dba'     => "Database administration utilities\n" .
                     "         Usage: php generate dba <command> [args...]\n" .
                     "         Commands: query, file\n" .
                     "         Example: php generate dba query \"SELECT * FROM users\"",
    ];

    foreach ($command_help as $cmd => $help) {
        echo "  $cmd\n";
        echo "         $help\n\n";
    }

    echo "For command-specific help, run:\n";
    echo "  php generate <command> --help\n\n";
    echo "Examples:\n";
    echo "  php generate route user-profile\n";
    echo "  php generate env\n";
    echo "  php generate migrate verify\n";
    echo "  php generate dba query \"SELECT version()\"\n";
}
