name: ${PROJECT_NAME:-sunbird}

services:
  # PostgreSQL Database - Internal only, no external ports
  db:
    image: postgres:16-alpine
    container_name: ${PROJECT_NAME:-sunbird}-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-sunbird_db}
      POSTGRES_USER: ${DB_USER:-sunbird_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init:/docker-entrypoint-initdb.d:ro
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-sunbird_user} -d ${DB_NAME:-sunbird_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # No ports exposed - database is only accessible within the internal network

  # StoneScriptPHP API Backend
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
      args:
        PHP_VERSION: ${PHP_VERSION:-8.3}
    container_name: ${PROJECT_NAME:-sunbird}-api
    restart: unless-stopped
    environment:
      # Application
      APP_ENV: ${APP_ENV:-development}
      APP_DEBUG: ${APP_DEBUG:-true}

      # Database connection
      DB_CONNECTION: pgsql
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-sunbird_db}
      DB_USER: ${DB_USER:-sunbird_user}
      DB_PASSWORD: ${DB_PASSWORD}

      # Security
      JWT_SECRET: ${JWT_SECRET}

      # CORS
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:4400}

      # Optional services
      MAIL_HOST: ${MAIL_HOST:-}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME:-}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-noreply@example.com}

      # Storage
      UPLOAD_MAX_SIZE: ${UPLOAD_MAX_SIZE:-10M}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      # Only bind to localhost (127.0.0.1) for security
      - "127.0.0.1:${API_PORT:-4402}:80"
    volumes:
      - ./api:/var/www/html
      - api_logs:/var/www/html/storage/logs
    networks:
      - internal
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Angular Frontend (StoneScript UI)
  www:
    build:
      context: ./www
      dockerfile: Dockerfile
      args:
        NODE_VERSION: ${NODE_VERSION:-20}
        API_URL: ${API_URL:-http://localhost:4402}
        ALERT_URL: ${ALERT_URL:-http://localhost:4401}
    container_name: ${PROJECT_NAME:-sunbird}-www
    restart: unless-stopped
    environment:
      NODE_ENV: ${APP_ENV:-development}
      API_URL: ${API_URL:-http://localhost:4402}
      ALERT_URL: ${ALERT_URL:-http://localhost:4401}
    ports:
      # Only bind to localhost (127.0.0.1) for security
      - "127.0.0.1:${WWW_PORT:-4400}:80"
    volumes:
      - ./www:/app
      - www_node_modules:/app/node_modules
      - www_dist:/app/dist
    networks:
      - internal
    depends_on:
      - api
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/health || wget -q --spider http://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Alert Service (Node.js + Express + Socket.IO)
  alert:
    build:
      context: ./alert
      dockerfile: Dockerfile
      args:
        NODE_VERSION: ${NODE_VERSION:-20}
    container_name: ${PROJECT_NAME:-sunbird}-alert
    restart: unless-stopped
    environment:
      NODE_ENV: ${APP_ENV:-development}
      ALERT_PORT: 3001
      CORS_ORIGINS: ${CORS_ORIGIN:-http://localhost:4400}

      # Database connection (if alert service needs DB access)
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-sunbird_db}
      DB_USER: ${DB_USER:-sunbird_user}
      DB_PASSWORD: ${DB_PASSWORD}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      # Only bind to localhost (127.0.0.1) for security
      - "127.0.0.1:${ALERT_PORT:-4401}:3001"
    volumes:
      - ./alert:/app
      - alert_node_modules:/app/node_modules
    networks:
      - internal
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  # Internal network - all services communicate through this
  internal:
    driver: bridge
    internal: false  # Set to true if you want to completely isolate from internet
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16

volumes:
  # PostgreSQL data persistence
  postgres_data:
    driver: local
    name: ${PROJECT_NAME:-sunbird}_postgres_data

  # API logs
  api_logs:
    driver: local
    name: ${PROJECT_NAME:-sunbird}_api_logs

  # Frontend node_modules (faster rebuilds)
  www_node_modules:
    driver: local
    name: ${PROJECT_NAME:-sunbird}_www_node_modules

  # Frontend dist (build artifacts)
  www_dist:
    driver: local
    name: ${PROJECT_NAME:-sunbird}_www_dist

  # Alert service node_modules
  alert_node_modules:
    driver: local
    name: ${PROJECT_NAME:-sunbird}_alert_node_modules
